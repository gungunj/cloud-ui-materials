name: Component PR Artifacts (Fault-Tolerant)

on:
  push:
    branches: ["test-ci-branch", "main"]
  pull_request:
    types: [closed]
    branches: ["main", "test-ci-branch"]
  workflow_dispatch:
    inputs:
      build_all:
        description: "æ„å»ºæ‰€æœ‰åŒ…ï¼ˆå¿½ç•¥å˜æ›´æ£€æµ‹ï¼‰"
        required: false
        type: boolean

jobs:
  plan:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Generate Plan
        id: set-matrix
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.build_all }}" = "true" ]; then
            echo "ğŸ”§ æ‰‹åŠ¨è§¦å‘ï¼šæ„å»ºæ‰€æœ‰åŒ…"
            RESULT=$(PLAN_ALL=1 node scripts/ci/plan-changed-packages.mjs)
          else
            echo "ğŸ”§ å¢é‡æ„å»ºï¼šæ£€æµ‹å˜æ›´çš„åŒ…"
            RESULT=$(node scripts/ci/plan-changed-packages.mjs)
          fi
          echo "matrix=$RESULT" >> $GITHUB_OUTPUT

          # è§£æç»“æœå¹¶æ˜¾ç¤ºä¿¡æ¯
          BATCH_COUNT=$(echo "$RESULT" | node -e "const d=require('fs').readFileSync(0,'utf8'); const j=JSON.parse(d); console.log(j.include?.length || 0)")
          if [ "$BATCH_COUNT" = "0" ]; then
            echo "âš ï¸ æ²¡æœ‰æ£€æµ‹åˆ°éœ€è¦æ„å»ºçš„åŒ…"
            echo "ğŸ’¡ æç¤ºï¼šå¦‚æœä½¿ç”¨ workflow_dispatchï¼Œè¯·å‹¾é€‰ 'æ„å»ºæ‰€æœ‰åŒ…' é€‰é¡¹"
          else
            echo "âœ… æ£€æµ‹åˆ° $BATCH_COUNT ä¸ªæ‰¹æ¬¡éœ€è¦æ„å»º"
          fi

  build-and-comment:
    needs: plan
    if: |
      (needs.plan.outputs.matrix != '' && fromJSON(needs.plan.outputs.matrix).include[0] != null) &&
      (
        github.event_name == 'push' ||
        github.event_name == 'workflow_dispatch' ||
        (github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true)
      )
    strategy:
      fail-fast: false
      matrix:
        batch: ${{ fromJSON(needs.plan.outputs.matrix).include }}
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Setup Dependencies (Stubs & Config)
        run: node scripts/ci/setup-dependencies.mjs

      - name: Configure Turbo
        run: node scripts/ci/configure-turbo.mjs

      - name: Install Root Dependencies
        run: |
          echo "ğŸš€ å¼€å§‹å®‰è£…æ ¹ç›®å½•ä¾èµ–..."
          # å®‰è£…æ ¹ç›®å½•ä¾èµ–ï¼ˆåŒ…æ‹¬ turboï¼‰ï¼Œä¸ä½¿ç”¨ --ignore-scripts ä»¥è§¦å‘ postinstall
          pnpm install --prefer-offline --no-frozen-lockfile || true
          echo "âœ… æ ¹ç›®å½•ä¾èµ–å®‰è£…å®Œæˆ"

      - name: Install Workspace Dependencies
        run: |
          echo "ğŸš€ å¼€å§‹å®‰è£…å„å·¥ä½œåŒºä¾èµ–..."
          # æ˜¾å¼æ‰§è¡Œå·¥ä½œåŒºå®‰è£…è„šæœ¬ï¼ˆç¡®ä¿æ‰€æœ‰å­å·¥ä½œåŒºçš„ä¾èµ–éƒ½å®‰è£…ï¼‰
          # è¿™ä¼šä¸ºæ¯ä¸ªå·¥ä½œåŒºï¼ˆlegacy-yaml, ts-vue2 ç­‰ï¼‰æ‰§è¡Œ pnpm install
          node scripts/mono/install-all-workspaces.mjs || true
          echo "âœ… å·¥ä½œåŒºä¾èµ–å®‰è£…å®Œæˆ"

      - name: Verify Critical Dependencies
        run: |
          echo "ğŸ” éªŒè¯å…³é”®ä¾èµ–..."
          # æ£€æŸ¥ turbo æ˜¯å¦å¯ç”¨
          if ! command -v turbo &> /dev/null; then
            echo "âš ï¸ turbo æœªæ‰¾åˆ°ï¼Œå°è¯•å…¨å±€å®‰è£…..."
            npm install -g turbo@2.5.8
          else
            echo "âœ… turbo å·²å®‰è£…: $(turbo --version)"
          fi

          # éªŒè¯ pnpm å·¥ä½œåŒºæ˜¯å¦æ­£ç¡®è¯†åˆ«
          echo "ğŸ“¦ éªŒè¯ pnpm å·¥ä½œåŒº..."
          pnpm list --depth=0 --json > /dev/null 2>&1 && echo "âœ… pnpm å·¥ä½œåŒºé…ç½®æ­£å¸¸" || echo "âš ï¸ pnpm å·¥ä½œåŒºé…ç½®å¯èƒ½æœ‰é—®é¢˜"

          echo "âœ… ä¾èµ–éªŒè¯å®Œæˆ"

      - name: Build and Package
        id: build-package
        continue-on-error: false
        run: |
          echo '${{ toJson(matrix.batch.items) }}' > batch_items.json
          node scripts/ci/build-and-package.mjs
        env:
          # Turbo è¿œç¨‹ç¼“å­˜é…ç½®ï¼ˆå¯é€‰ï¼‰
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
          TURBO_TEAM: ${{ secrets.TURBO_TEAM }}

      - name: Check Build Results
        if: always()
        run: |
          echo "ğŸ” æ£€æŸ¥æ„å»ºç»“æœ..."
          if [ -f "build_results.json" ]; then
            FAIL_COUNT=$(node -e "const fs=require('fs'); const data=JSON.parse(fs.readFileSync('build_results.json','utf8')); console.log(data.filter(r=>r.status==='failed').length)")
            if [ "$FAIL_COUNT" -gt 0 ]; then
              echo "âŒ æ£€æµ‹åˆ° $FAIL_COUNT ä¸ªåŒ…æ„å»ºå¤±è´¥"
              echo ""
              echo "å¤±è´¥è¯¦æƒ…:"
              node -e "
                const fs = require('fs');
                const data = JSON.parse(fs.readFileSync('build_results.json', 'utf8'));
                data
                  .filter(r => r.status === 'failed')
                  .forEach(r => {
                    console.log(\`  - \${r.name}: \${r.error}\`);
                  });
              "
              exit 1
            else
              echo "âœ… æ‰€æœ‰åŒ…æ„å»ºæˆåŠŸ"
            fi
          else
            echo "âš ï¸ æ„å»ºç»“æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•éªŒè¯"
            exit 1
          fi

      # - name: Generate Diff Description and Update Documentation
      # if: github.event_name == 'push'
      #   run: node scripts/ci/generate-diff-docs.mjs
      #   env:
      #     COREAGENT_AK: ${{ secrets.COREAGENT_AK }}
      #     COREAGENT_SK: ${{ secrets.COREAGENT_SK }}

      # - name: Generate CHANGELOG
      #   if: github.event_name == 'push'
      #   run: node scripts/ci/generate-changelog.mjs
      #   env:
      #     GITHUB_SERVER_URL: ${{ github.server_url }}
      #     GITHUB_REPOSITORY: ${{ github.repository }}

      # - name: Create Git Tags and Commit CHANGELOG
      #   if: github.event_name == 'push'
      #   run: node scripts/ci/create-tags.mjs
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # - name: Upload Artifacts
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: components-v${{ github.run_number }}-${{ strategy.job-index }}
      #     path: upload_artifacts/*.zip
      #     retention-days: 7

      # - name: Create or Update GitHub Release
      #   if: github.event_name == 'push'
      #   uses: actions/github-script@v7
      #   with:
      #     script: |
      #       const createRelease = require('./scripts/ci/create-release.js');
      #       await createRelease({ github, context });

      # - name: Find PR Number (for merged PRs)
      #   if: github.event_name == 'push'
      #   id: find-pr
      #   uses: actions/github-script@v7
      #   with:
      #     script: |
      #       const core = require('@actions/core');
      #       const findPR = require('./scripts/ci/find-pr.js');
      #       await findPR({ github, context, core });

      # - name: Comment on PR
      #   if: |
      #     (github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true) ||
      #     (github.event_name == 'push' && steps.find-pr.outputs.pr_number != '')
      #   uses: actions/github-script@v7
      #   with:
      #     script: |
      #       const commentPR = require('./scripts/ci/comment-pr.js');

      #       let prNumber;
      #       let isMerged = false;

      #       if (context.eventName === 'pull_request') {
      #         prNumber = context.issue.number;
      #         isMerged = context.payload.pull_request?.merged === true || context.payload.action === 'closed';
      #       } else if (context.eventName === 'push') {
      #         prNumber = parseInt('${{ steps.find-pr.outputs.pr_number }}');
      #         isMerged = true;
      #       }

      #       const jobIndex = '${{ strategy.job-index }}';

      #       await commentPR({ github, context }, prNumber, isMerged, jobIndex);
