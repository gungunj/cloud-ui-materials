name: Component PR Preview & Sync

on:
  push:
    branches: [ "test-ci-branch" ]
  pull_request:
    branches: [ "main", "test-ci-branch" ]
  workflow_dispatch:

jobs:
  plan:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Generate Plan
        id: set-matrix
        run: |
          RESULT=$(node scripts/ci/plan-changed-packages.mjs)
          echo "matrix=$RESULT" >> $GITHUB_OUTPUT

  build-and-comment:
    needs: plan
    if: needs.plan.outputs.matrix != '' && fromJSON(needs.plan.outputs.matrix).include[0] != null
    strategy:
      fail-fast: false
      matrix:
        batch: ${{ fromJSON(needs.plan.outputs.matrix).include }}
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write # å¿…é¡»å¼€å¯ PR å†™å…¥æƒé™ä»¥å›è´´
    steps:
      - uses: actions/checkout@v4
      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Authenticate and Install
        run: |
          echo "registry=https://npm.nie.netease.com/" > .npmrc
          echo "always-auth=true" >> .npmrc
          pnpm install --prefer-offline
          npm install -g turbo

      - name: Build and Package
        id: build_step
        run: |
          echo '${{ toJson(matrix.batch.items) }}' > batch_items.json
          
          # æ‰§è¡Œæ„å»ºå¹¶è®°å½•äº§ç‰©è·¯å¾„
          node -e "
          const fs = require('fs');
          const cp = require('child_process');
          const path = require('path');
          const items = JSON.parse(fs.readFileSync('batch_items.json', 'utf8'));
          let summary = '';

          for (const pkg of items) {
            try {
              console.log('--- æ„å»º: ' + pkg.name);
              cp.execSync('turbo run build --filter=' + pkg.name, { stdio: 'inherit' });

              const zipName = \`\${pkg.name.replace(/[@/]/g, '-')}.zip\`;
              cp.execSync(\`zip -r \${zipName} dist/\`, { cwd: pkg.dir, stdio: 'inherit' });
              
              // ç§»åŠ¨åˆ°ç»Ÿä¸€çš„äº§ç‰©ç›®å½•æ–¹ä¾¿ä¸Šä¼ 
              const artifactDir = path.join(process.cwd(), 'upload_artifacts');
              if (!fs.existsSync(artifactDir)) fs.mkdirSync(artifactDir);
              fs.renameSync(path.join(pkg.dir, zipName), path.join(artifactDir, zipName));
              
              summary += '- âœ… ' + pkg.name + ' (å·²æ‰“åŒ…)\\n';
            } catch (err) {
              summary += '- âŒ ' + pkg.name + ' (æ„å»ºå¤±è´¥)\\n';
            }
          }
          fs.writeFileSync('build_summary.txt', summary);
          "

      # ä¸Šä¼ äº§ç‰©åˆ° GitHub Actions
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: components-batch-${{ strategy.job-index }}
          path: upload_artifacts/*.zip
          retention-days: 7

      # åœ¨ PR ä¸Šè‡ªåŠ¨å›å¤ä¸‹è½½å¼•å¯¼
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('build_summary.txt', 'utf8');
            const run_id = context.runId;
            const commentBody = `### ğŸ“¦ ç»„ä»¶æ„å»ºå®Œæˆ (Batch ${{ strategy.job-index }})\n\n${summary}\n\n[ç‚¹å‡»æ­¤å¤„è¿›å…¥ Actions é¡µé¢ä¸‹è½½äº§ç‰©](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${run_id})`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            })