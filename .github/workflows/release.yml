name: Component PR Artifacts (Fault-Tolerant)

on:
  push:
    branches: ["test-ci-branch", "main"]
  pull_request:
    types: [closed]
    branches: ["main", "test-ci-branch"]
  workflow_dispatch:

jobs:
  plan:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Generate Plan
        id: set-matrix
        run: |
          RESULT=$(node scripts/ci/plan-changed-packages.mjs)
          echo "matrix=$RESULT" >> $GITHUB_OUTPUT

  build-and-comment:
    needs: plan
    if: |
      (needs.plan.outputs.matrix != '' && fromJSON(needs.plan.outputs.matrix).include[0] != null) &&
      (
        github.event_name == 'push' ||
        github.event_name == 'workflow_dispatch' ||
        (github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true)
      )
    strategy:
      fail-fast: false
      matrix:
        batch: ${{ fromJSON(needs.plan.outputs.matrix).include }}
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Setup Dependencies (Stubs & Config)
        run: node scripts/ci/setup-dependencies.mjs

      - name: Configure Turbo
        run: node scripts/ci/configure-turbo.mjs

      - name: Install Dependencies
        run: |
          echo "üöÄ ÂºÄÂßãÂÆâË£Ö‰æùËµñ..."
          # pnpm.overrides Â∑≤Âú® package.json ‰∏≠ÈÖçÁΩÆÔºå‰ºöËá™Âä®‰ΩøÁî®Êú¨Âú∞ stubs
          pnpm install --prefer-offline --no-frozen-lockfile --ignore-scripts || true

      - name: Install Turbo
        run: npm install -g turbo

      - name: Build and Package
        run: |
          echo '${{ toJson(matrix.batch.items) }}' > batch_items.json
          node scripts/ci/build-and-package.mjs
        env:
          # Turbo ËøúÁ®ãÁºìÂ≠òÈÖçÁΩÆÔºàÂèØÈÄâÔºâ
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
          TURBO_TEAM: ${{ secrets.TURBO_TEAM }}

      - name: Generate Diff Description and Update Documentation
        if: github.event_name == 'push'
        run: node scripts/ci/generate-diff-docs.mjs
        env:
          COREAGENT_AK: ${{ secrets.COREAGENT_AK }}
          COREAGENT_SK: ${{ secrets.COREAGENT_SK }}

      - name: Generate CHANGELOG
        if: github.event_name == 'push'
        run: node scripts/ci/generate-changelog.mjs
        env:
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Create Git Tags and Commit CHANGELOG
        if: github.event_name == 'push'
        run: node scripts/ci/create-tags.mjs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: components-v${{ github.run_number }}-${{ strategy.job-index }}
          path: upload_artifacts/*.zip
          retention-days: 7

      - name: Create or Update GitHub Release
        if: github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const createRelease = require('./scripts/ci/create-release.js');
            await createRelease({ github, context });

      - name: Find PR Number (for merged PRs)
        if: github.event_name == 'push'
        id: find-pr
        uses: actions/github-script@v7
        with:
          script: |
            const core = require('@actions/core');
            const findPR = require('./scripts/ci/find-pr.js');
            await findPR({ github, context, core });

      - name: Comment on PR
        if: |
          (github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true) ||
          (github.event_name == 'push' && steps.find-pr.outputs.pr_number != '')
        uses: actions/github-script@v7
        with:
          script: |
            const commentPR = require('./scripts/ci/comment-pr.js');

            let prNumber;
            let isMerged = false;

            if (context.eventName === 'pull_request') {
              prNumber = context.issue.number;
              isMerged = context.payload.pull_request?.merged === true || context.payload.action === 'closed';
            } else if (context.eventName === 'push') {
              prNumber = parseInt('${{ steps.find-pr.outputs.pr_number }}');
              isMerged = true;
            }

            const jobIndex = '${{ strategy.job-index }}';

            await commentPR({ github, context }, prNumber, isMerged, jobIndex);
