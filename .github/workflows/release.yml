name: Component PR Artifacts (Fault-Tolerant)

on:
  push:
    branches: [ "test-ci-branch" ]
  pull_request:
    branches: [ "main", "test-ci-branch" ]
  workflow_dispatch:

jobs:
  plan:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Generate Plan
        id: set-matrix
        run: |
          RESULT=$(node scripts/ci/plan-changed-packages.mjs)
          echo "matrix=$RESULT" >> $GITHUB_OUTPUT

  build-and-comment:
    needs: plan
    if: needs.plan.outputs.matrix != '' && fromJSON(needs.plan.outputs.matrix).include[0] != null
    strategy:
      fail-fast: false
      matrix:
        batch: ${{ fromJSON(needs.plan.outputs.matrix).include }}
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Fault-Tolerant Setup & Install
        run: |
          # 1. åŠ¨æ€åˆ›å»º pnpm æ‹¦æˆªé’©å­
          cat << 'EOF' > .pnpmfile.cjs
          module.exports = {
            hooks: {
              readPackage(pkg) {
                // åˆ—å‡ºæ‰€æœ‰å¯¼è‡´ ECONNRESET çš„å†…ç½‘ç§æœ‰åŒ…å
                const problematicPackages = [
                  '@oa/iframe-channel',
                  '@popo-bridge/web',
                  '@ysf/fetch'
                ];

                const removeDeps = (deps) => {
                  if (!deps) return;
                  problematicPackages.forEach(name => {
                    if (deps[name]) {
                      delete deps[name];
                    }
                  });
                };

                removeDeps(pkg.dependencies);
                removeDeps(pkg.devDependencies);
                removeDeps(pkg.peerDependencies);
                return pkg;
              }
            }
          }
          EOF

          # 2. å¼ºåˆ¶ä½¿ç”¨å®˜æ–¹æºå¹¶æ‰§è¡Œå®‰è£…
          echo "registry=https://registry.npmjs.org/" > .npmrc
          echo "ğŸš€ å¼€å§‹å®¹é”™å®‰è£…..."
          # ä½¿ç”¨ --no-frozen-lockfile å…è®¸ä¿®æ”¹åçš„ä¾èµ–æ ‘é€šè¿‡æ ¡éªŒ
          pnpm install --prefer-offline --no-frozen-lockfile --ignore-scripts || true
          
          # 3. è¡¥è£…å…¨å±€å·¥å…·
          npm install -g turbo

      - name: Build and Package
        run: |
          echo '${{ toJson(matrix.batch.items) }}' > batch_items.json
          
          node -e "
          const fs = require('fs');
          const cp = require('child_process');
          const path = require('path');
          const items = JSON.parse(fs.readFileSync('batch_items.json', 'utf8'));
          let summary = '';

          for (const pkg of items) {
            console.log('ğŸ“¦ æ­£åœ¨å°è¯•å¤„ç†: ' + pkg.name);
            try {
              // æ‰§è¡Œæ„å»ºï¼Œå³ä½¿ç¼ºå°‘æŸäº›è¢«åˆ é™¤çš„ç§æœ‰åŒ…ä¹Ÿä¼šå°è¯•ç¼–è¯‘
              cp.execSync('turbo run build --filter=' + pkg.name, { stdio: 'inherit' });

              const zipName = \`\${pkg.name.replace(/[@/]/g, '-')}.zip\`;
              cp.execSync(\`zip -r \${zipName} dist/\`, { cwd: pkg.dir, stdio: 'inherit' });
              
              const artifactDir = path.join(process.cwd(), 'upload_artifacts');
              if (!fs.existsSync(artifactDir)) fs.mkdirSync(artifactDir);
              fs.renameSync(path.join(pkg.dir, zipName), path.join(artifactDir, zipName));
              
              summary += '- âœ… ' + pkg.name + '\\n';
            } catch (err) {
              console.warn('âš ï¸ ' + pkg.name + ' æ„å»ºå¤±è´¥ï¼ˆå¯èƒ½ç¼ºå°‘ç§æœ‰ä¾èµ–ï¼‰');
              summary += '- âŒ ' + pkg.name + ' (å¤±è´¥)\\n';
            }
          }
          fs.writeFileSync('build_summary.txt', summary);
          "

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: components-v${{ github.run_number }}-${{ strategy.job-index }}
          path: upload_artifacts/*.zip
          retention-days: 7

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('build_summary.txt', 'utf8');
            const body = `### ğŸ“¦ PR æ„å»ºäº§ç‰©é¢„è§ˆ (Batch ${{ strategy.job-index }})\n\n${summary}\n\n[ç‚¹å‡»æ­¤å¤„è¿›å…¥ Run è¯¦æƒ…é¡µä¸‹è½½ Artifacts](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            })